rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isAdmin() {
      return request.auth != null && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    // Public mapping for resolving agents by token/code
    match /agentTokens/{id} {
      allow read: if true;
      allow write: if request.auth != null; // only authenticated app users write
    }

    // Admins registry: readable by the admin user himself; not writable from client
    match /admins/{uid} {
      allow read: if request.auth != null && request.auth.uid == uid;
      allow write: if false;
    }

    // Public read for events and tickets
    match /profiles/{userId}/events/{eventId} {
      allow read: if true;
      allow write: if request.auth != null && (request.auth.uid == userId || isAdmin());
      match /tickets/{ticketId} {
        allow read: if true;
        allow write: if request.auth != null && (request.auth.uid == userId || isAdmin());
      }
    }

    // Products: public read, owner or admin write
    match /profiles/{userId}/products/{productId} {
      allow read: if true;
      allow write: if request.auth != null && (request.auth.uid == userId || isAdmin());
    }

    // Tables: public read for QR ordering, owner or admin write
    match /profiles/{userId}/tables/{tableId} {
      allow read: if true;
      allow write: if request.auth != null && (request.auth.uid == userId || isAdmin());
    }

    // Orders: public read; writes allowed for owner, valid agent token mapping, or admin
    match /profiles/{userId}/orders/{orderId} {
      allow read: if true;
      allow write: if (
        request.auth != null && (request.auth.uid == userId || isAdmin())
      ) || (
        // Validate that the request carries an agentToken that maps to this owner
        // and that mapping exists in top-level agentTokens
        exists(/databases/$(database)/documents/agentTokens/$(request.resource.data.agentToken)) &&
        get(/databases/$(database)/documents/agentTokens/$(request.resource.data.agentToken)).data.ownerUid == userId
      );
    }

    // BarOrders: public write for QR code ordering, owner/admin read
    match /profiles/{userId}/barOrders/{orderId} {
      allow read: if request.auth != null && (request.auth.uid == userId || isAdmin());
      allow create: if true; // Permettre à tout le monde de créer des commandes (QR code public)
      allow update, delete: if request.auth != null && (request.auth.uid == userId || isAdmin());
    }

    // Order cancellations: owner/admin only (audit log)
    match /profiles/{userId}/orderCancellations/{cancellationId} {
      allow read, write: if request.auth != null && (request.auth.uid == userId || isAdmin());
    }

    // Team subcollection: owner or admin
    match /profiles/{userId}/team/{memberId} {
      allow read, write: if request.auth != null && (request.auth.uid == userId || isAdmin());
    }

    // Profiles: public read for map functionality, owner/admin write
    // Note: The locations.ts library filters sensitive data before returning
    match /profiles/{userId} {
      // Allow public read for QR code ordering functionality
      allow read: if true;
      // Only owner or admin can write
      allow write: if request.auth != null && (request.auth.uid == userId || isAdmin());
      
      // Note: Les sous-collections spécifiques (products, tables, orders, events) sont définies AVANT
      // cette règle générale pour éviter les conflits. Cette règle générale ne s'applique qu'aux
      // autres sous-collections non spécifiées (team, notifications, etc.)
      match /{document=**} {
        // Pour les autres sous-collections non spécifiées, seul le propriétaire ou admin peut accéder
        allow read, write: if request.auth != null && (request.auth.uid == userId || isAdmin());
      }
    }

    // Subscription plans: admin only read/write
    match /subscriptionPlans/{planId} {
      allow read, write: if isAdmin();
    }

    // Affiliates: public read by code (for affiliate dashboard), admin write
    match /affiliates/{code} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Disbursement requests: users can create, admins can read/write
    match /disbursementRequests/{requestId} {
      // Les utilisateurs authentifiés peuvent créer leur propre demande
      allow create: if request.auth != null && 
                      request.resource.data.userId == request.auth.uid &&
                      request.resource.data.status == 'pending';
      // Les utilisateurs peuvent lire leur propre demande
      allow read: if request.auth != null && 
                   (resource.data.userId == request.auth.uid || isAdmin());
      // Seuls les admins peuvent mettre à jour ou supprimer
      allow update, delete: if isAdmin();
    }
  }
}
